name: Build VolumeMixer
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      - name: Install LibActivator Headers
        run: |
          git clone https://github.com/rpetrich/libactivator.git libactivator_src
          mkdir -p $HOME/theos/include/libactivator
          cp libactivator_src/*.h $HOME/theos/include/libactivator/ 2>/dev/null || true
          rm -rf libactivator_src

      - name: Install Ldid
        run: |
          curl -L https://github.com/ProcursusTeam/ldid/releases/download/v2.1.5-procursus7/ldid_macosx_x86_64 -o /tmp/ldid
          chmod +x /tmp/ldid
          sudo mv /tmp/ldid /usr/local/bin/ldid

      - name: Install Preferences Framework
        run: |
          # Find Xcode SDK path
          XCODE_PATH=$(xcode-select -p)
          XCODE_SDK="$XCODE_PATH/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk"
          
          # Create Theos SDK directory structure
          THEOS_SDK="$HOME/theos/sdks/iPhoneOS16.5.sdk"
          mkdir -p "$THEOS_SDK/System/Library/PrivateFrameworks"
          
          # Copy Preferences.framework from Xcode to Theos
          if [ -d "$XCODE_SDK/System/Library/PrivateFrameworks/Preferences.framework" ]; then
            cp -R "$XCODE_SDK/System/Library/PrivateFrameworks/Preferences.framework" \
                  "$THEOS_SDK/System/Library/PrivateFrameworks/"
            echo "✅ Preferences.framework copied successfully"
          else
            echo "❌ Preferences.framework not found in Xcode SDK"
            echo "Xcode SDK path: $XCODE_SDK"
            ls -la "$XCODE_SDK/System/Library/PrivateFrameworks/" || true
            exit 1
          fi

      - name: Build VolumeMixer (arm64e for M2)
        env:
          THEOS: ${{ env.THEOS }}
        run: |
          export THEOS=$HOME/theos
          export SDKVERSION=16.0
          
          # Clean previous builds
          make clean || true
          
          # Build with explicit flags for iOS 16 / arm64e
          make package \
            FINALPACKAGE=1 \
            THEOS_PACKAGE_SCHEME=rootless \
            DEBUG=0 \
            ARCHS=arm64e \
            TARGET=iphone:clang:latest:16.0

      - name: Check Build Output
        run: |
          echo "Contents of packages directory:"
          ls -lah packages/ 2>/dev/null || echo "No packages directory"
          echo ""
          echo "Contents of .theos directory:"
          ls -lah .theos/obj/ 2>/dev/null || echo "No .theos/obj directory"

      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: VolumeMixer_DEB_iOS16
          path: packages/*.deb
