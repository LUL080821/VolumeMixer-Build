name: Build VolumeMixer
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      - name: Install iOS SDK
        run: |
          cd $HOME/theos
          curl -LO https://github.com/theos/sdks/archive/master.zip
          unzip master.zip
          mv sdks-master sdks
          rm master.zip
          echo "‚úÖ Theos SDKs installed"

      - name: Install LibActivator Headers
        run: |
          git clone https://github.com/rpetrich/libactivator.git libactivator_src
          mkdir -p $HOME/theos/include/libactivator
          cp libactivator_src/*.h $HOME/theos/include/libactivator/ 2>/dev/null || true
          rm -rf libactivator_src
          echo "‚úÖ LibActivator headers installed"

      - name: Install AltList Framework
        run: |
          # Clone AltList repository
          git clone https://github.com/opa334/AltList.git altlist_src
          
          # Copy headers
          mkdir -p $HOME/theos/include/AltList
          if [ -d "altlist_src/AltList" ]; then
            cp altlist_src/AltList/*.h $HOME/theos/include/AltList/ 2>/dev/null || true
          fi
          if [ -d "altlist_src" ]; then
            find altlist_src -name "*.h" -exec cp {} $HOME/theos/include/AltList/ \; 2>/dev/null || true
          fi
          
          # Create stub .tbd for linking
          mkdir -p $HOME/theos/lib
          cat > $HOME/theos/lib/AltList.tbd << 'EOF'
---
archs:           [ arm64, arm64e ]
platform:        ios
install-name:    /Library/Frameworks/AltList.framework/AltList
exports:
  - archs:           [ arm64, arm64e ]
    symbols:         [ _OBJC_CLASS_$_ATLApplicationListController ]
EOF
          
          rm -rf altlist_src
          echo "‚úÖ AltList framework installed"

      - name: Install Ldid
        run: |
          curl -L https://github.com/ProcursusTeam/ldid/releases/download/v2.1.5-procursus7/ldid_macosx_x86_64 -o /tmp/ldid
          chmod +x /tmp/ldid
          sudo mv /tmp/ldid /usr/local/bin/ldid
          echo "‚úÖ ldid installed"

      - name: Setup Preferences Framework
        run: |
          FOUND_HEADERS=0
          
          # Try theos-sdks first (most reliable)
          LATEST_SDK=$(ls -d $HOME/theos/sdks/iPhoneOS*.sdk 2>/dev/null | sort -V | tail -1)
          if [ -n "$LATEST_SDK" ]; then
            echo "üì¶ Using SDK: $LATEST_SDK"
            
            # Copy Preferences headers
            if [ -d "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework" ]; then
              mkdir -p "$HOME/theos/include/Preferences"
              
              if [ -d "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers" ]; then
                cp -R "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers/"* "$HOME/theos/include/Preferences/"
                FOUND_HEADERS=1
              else
                find "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework" -name "*.h" -exec cp {} "$HOME/theos/include/Preferences/" \; 2>/dev/null
                if [ -f "$HOME/theos/include/Preferences/PSListController.h" ]; then
                  FOUND_HEADERS=1
                fi
              fi
            fi
          fi
          
          # Fallback: Download from theos/headers repository
          if [ $FOUND_HEADERS -eq 0 ]; then
            echo "‚ö†Ô∏è  Downloading Preferences headers from GitHub..."
            mkdir -p "$HOME/theos/include/Preferences"
            
            curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/PSListController.h" -o "$HOME/theos/include/Preferences/PSListController.h" || true
            curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/PSSpecifier.h" -o "$HOME/theos/include/Preferences/PSSpecifier.h" || true
            curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/PSTableCell.h" -o "$HOME/theos/include/Preferences/PSTableCell.h" || true
            curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/PSViewController.h" -o "$HOME/theos/include/Preferences/PSViewController.h" || true
            
            if [ -f "$HOME/theos/include/Preferences/PSListController.h" ]; then
              FOUND_HEADERS=1
            fi
          fi
          
          if [ $FOUND_HEADERS -eq 0 ]; then
            echo "‚ùå Failed to get Preferences headers"
            exit 1
          fi
          
          echo "‚úÖ Preferences headers installed"
          
          # Copy Preferences.tbd for linking
          mkdir -p "$HOME/theos/lib"
          if [ -f "theos/lib/Preferences.tbd" ]; then
            cp theos/lib/Preferences.tbd "$HOME/theos/lib/"
            echo "‚úÖ Preferences.tbd copied"
          else
            echo "‚ùå Preferences.tbd not found in repo"
            exit 1
          fi
          
          # Verify
          echo ""
          echo "üìã Installed headers:"
          ls -la "$HOME/theos/include/Preferences/" | head -10

      - name: Build VolumeMixer (arm64e for M2)
        env:
          THEOS: ${{ env.THEOS }}
        run: |
          export THEOS=$HOME/theos
          export SDKVERSION=16.0
          
          make clean || true
          
          make package \
            FINALPACKAGE=1 \
            THEOS_PACKAGE_SCHEME=rootless \
            DEBUG=0 \
            ARCHS=arm64e \
            TARGET=iphone:clang:latest:16.0

      - name: Check Build Output
        run: |
          echo "üì¶ Build artifacts:"
          ls -lah packages/ 2>/dev/null || echo "No packages directory"
          echo ""
          if [ -f packages/*.deb ]; then
            echo "‚úÖ DEB file created successfully!"
            ls -lh packages/*.deb
          else
            echo "‚ùå No DEB file found"
          fi

      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: VolumeMixer_DEB_iOS16
          path: packages/*.deb
