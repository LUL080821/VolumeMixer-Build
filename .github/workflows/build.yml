name: Build VolumeMixer
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dpkg (Critical for packaging)
        run: |
          echo "üì¶ Installing dpkg for .deb package creation..."
          brew install dpkg
          which dpkg-deb
          dpkg-deb --version
          echo "‚úÖ dpkg-deb installed and verified"

      - name: Install Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "‚úÖ Theos installed"

      - name: Install iOS SDK
        run: |
          set -e
          echo "üì¶ Downloading and installing iOS SDK 16.5..."
          cd $HOME/theos
          
          mkdir -p sdks
          echo "Downloading iPhoneOS16.5.sdk.tar.xz..."
          curl -L https://github.com/theos/sdks/releases/latest/download/iPhoneOS16.5.sdk.tar.xz -o sdks/iPhoneOS16.5.sdk.tar.xz
          
          echo "Extracting SDK..."
          cd sdks
          tar -xf iPhoneOS16.5.sdk.tar.xz
          rm iPhoneOS16.5.sdk.tar.xz
          
          if [ ! -d "iPhoneOS16.5.sdk" ]; then
            echo "‚ùå ERROR: iPhoneOS16.5.sdk not found!"
            exit 1
          fi
          echo "‚úÖ iPhoneOS16.5.sdk verified and installed"

      - name: Install LibActivator Headers
        run: |
          git clone --depth=1 https://github.com/rpetrich/libactivator.git libactivator_src
          mkdir -p $HOME/theos/include/libactivator
          cp libactivator_src/*.h $HOME/theos/include/libactivator/ 2>/dev/null || true
          rm -rf libactivator_src
          echo "‚úÖ LibActivator headers installed"

      - name: Install AltList Framework (ROOTLESS FIX)
        run: |
          git clone --depth=1 https://github.com/opa334/AltList.git altlist_src
          
          # Install headers
          mkdir -p $HOME/theos/include/AltList
          find altlist_src -name "*.h" -exec cp {} $HOME/theos/include/AltList/ \; 2>/dev/null || true
          
          # Create framework structure for rootless jailbreak
          echo "üîß Creating AltList.framework for rootless jailbreak..."
          mkdir -p "$HOME/theos/lib/iphone/rootless/AltList.framework"
          
          # Create proper TBD v4 file with correct YAML syntax
          cat > "$HOME/theos/lib/iphone/rootless/AltList.framework/AltList" << 'EOF'
--- !tapi-tbd
tbd-version: 4
targets: [ arm64-ios, arm64e-ios ]
install-name: '@rpath/AltList.framework/AltList'
current-version: 1.0
compatibility-version: 1.0
exports:
  - targets: [ arm64-ios, arm64e-ios ]
    symbols: [ '_OBJC_CLASS_$_ATLApplicationListController' ]
    objc-classes: [ 'ATLApplicationListController' ]
...
EOF
          
          echo "‚úÖ AltList.framework TBD created with @rpath"
          echo "üìÑ TBD file contents:"
          cat "$HOME/theos/lib/iphone/rootless/AltList.framework/AltList"
          
          rm -rf altlist_src

      - name: Install Ldid
        run: |
          curl -L https://github.com/ProcursusTeam/ldid/releases/download/v2.1.5-procursus7/ldid_macosx_x86_64 -o /tmp/ldid
          chmod +x /tmp/ldid
          sudo mv /tmp/ldid /usr/local/bin/ldid
          ldid -V || echo "ldid installed"
          echo "‚úÖ ldid installed"

      - name: Setup Preferences Framework
        run: |
          mkdir -p "$HOME/theos/lib/iphone/rootless"
          
          if [ -f "theos/lib/Preferences.tbd" ]; then
            echo "‚úÖ Using Preferences.tbd from repository"
            cp theos/lib/Preferences.tbd "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
          else
            echo "‚ö†Ô∏è Creating Preferences.tbd"
            echo "---" > "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "archs:           [ arm64, arm64e ]" >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "platform:        ios" >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "install-name:    /System/Library/PrivateFrameworks/Preferences.framework/Preferences" >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "exports:" >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "  - archs:           [ arm64, arm64e ]" >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "    symbols:         [ ]" >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "..." >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
          fi
          
          cd "$HOME/theos/lib/iphone/rootless"
          ln -sf Preferences.tbd libPreferences.tbd
          echo "‚úÖ Preferences framework ready"
          
          mkdir -p "$HOME/theos/include/Preferences"
          LATEST_SDK=$(ls -d $HOME/theos/sdks/iPhoneOS*.sdk 2>/dev/null | sort -V | tail -1)
          if [ -n "$LATEST_SDK" ] && [ -d "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers" ]; then
            cp -R "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers/"* "$HOME/theos/include/Preferences/"
          else
            for header in PSListController.h PSSpecifier.h PSTableCell.h PSViewController.h; do
              curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/$header" -o "$HOME/theos/include/Preferences/$header" || true
            done
          fi

      - name: Build VolumeMixer (iOS 16.0 arm64e Rootless)
        env:
          THEOS: ${{ env.THEOS }}
        run: |
          export THEOS=$HOME/theos
          export PATH="/usr/local/bin:$PATH"
          
          echo "üî® Building VolumeMixer for iOS 16.0 arm64e (M2 iPad Dopamine2-roothide)"
          
          if ! command -v dpkg-deb &> /dev/null; then
            echo "‚ùå CRITICAL: dpkg-deb not found!"
            exit 1
          fi
          
          if [ ! -d "$THEOS/sdks/iPhoneOS16.5.sdk" ]; then
            echo "‚ùå CRITICAL: SDK not found!"
            exit 1
          fi
          
          echo "‚úÖ All pre-build checks passed"
          
          make clean || true
          rm -rf packages .theos/_/packages 2>/dev/null || true
          
          echo "üîß Building with rootless settings..."
          make package FINALPACKAGE=1 DEBUG=0 MESSAGES=yes 2>&1 | tee build.log
          
          BUILD_STATUS=${PIPESTATUS[0]}
          if [ $BUILD_STATUS -ne 0 ]; then
            echo "‚ùå Build failed!"
            tail -100 build.log
            exit $BUILD_STATUS
          fi
          
          echo "‚úÖ Build completed successfully"

      - name: Verify Package
        run: |
          FOUND_DEBS=$(find . -name "*.deb" -type f 2>/dev/null)
          if [ -z "$FOUND_DEBS" ]; then
            echo "‚ùå No .deb files generated!"
            exit 1
          fi
          
          echo "‚úÖ Package(s) generated:"
          echo "$FOUND_DEBS" | while read deb; do
            echo "üì¶ $deb"
            dpkg-deb --info "$deb" || true
            dpkg-deb --contents "$deb" | head -20
          done

      - name: Prepare Artifacts
        run: |
          mkdir -p artifacts
          find . -name "*.deb" -type f -exec cp {} artifacts/ \;
          ls -lah artifacts/

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: VolumeMixer-iOS16-arm64e-rootless-M2
          path: artifacts/*.deb
          if-no-files-found: error
          retention-days: 90

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build.log
            .theos/_/DEBIAN/control
          if-no-files-found: ignore
          retention-days: 30
