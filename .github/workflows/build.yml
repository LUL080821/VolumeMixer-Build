name: Build VolumeMixer
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      - name: Install iOS SDK
        run: |
          # Download iOS SDK from theos-sdks for consistent headers
          cd $HOME/theos
          git clone https://github.com/theos/sdks.git sdks
          echo "✅ Theos SDKs installed"

      - name: Install LibActivator Headers
        run: |
          git clone https://github.com/rpetrich/libactivator.git libactivator_src
          mkdir -p $HOME/theos/include/libactivator
          cp libactivator_src/*.h $HOME/theos/include/libactivator/ 2>/dev/null || true
          rm -rf libactivator_src

      - name: Install Ldid
        run: |
          curl -L https://github.com/ProcursusTeam/ldid/releases/download/v2.1.5-procursus7/ldid_macosx_x86_64 -o /tmp/ldid
          chmod +x /tmp/ldid
          sudo mv /tmp/ldid /usr/local/bin/ldid

      - name: Setup Preferences Framework Headers and Library
        run: |
          # Try to get Preferences headers from Xcode SDK first
          XCODE_PATH=$(xcode-select -p)
          XCODE_SDK="$XCODE_PATH/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk"
          
          FOUND_HEADERS=0
          
          # Method 1: Try Xcode SDK Headers directory
          if [ -d "$XCODE_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers" ]; then
            echo "✅ Found Preferences headers in Xcode SDK"
            mkdir -p "$HOME/theos/include/Preferences"
            cp -R "$XCODE_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers/"* "$HOME/theos/include/Preferences/"
            FOUND_HEADERS=1
          fi
          
          # Method 2: Try theos-sdks (already cloned)
          if [ $FOUND_HEADERS -eq 0 ]; then
            echo "⚠️  Xcode headers not found, checking theos-sdks..."
            # Find latest SDK in theos/sdks
            LATEST_SDK=$(ls -d $HOME/theos/sdks/iPhoneOS*.sdk 2>/dev/null | sort -V | tail -1)
            if [ -n "$LATEST_SDK" ] && [ -d "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework" ]; then
              echo "✅ Found Preferences in theos SDK: $LATEST_SDK"
              mkdir -p "$HOME/theos/include/Preferences"
              if [ -d "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers" ]; then
                cp -R "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers/"* "$HOME/theos/include/Preferences/"
              else
                # Try copying .h files directly
                find "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework" -name "*.h" -exec cp {} "$HOME/theos/include/Preferences/" \; 2>/dev/null || true
              fi
              FOUND_HEADERS=1
            fi
          fi
          
          # Method 3: Download from iphoneheaders.com or similar (last resort)
          if [ $FOUND_HEADERS -eq 0 ]; then
            echo "⚠️  Downloading Preferences headers from public source..."
            mkdir -p "$HOME/theos/include/Preferences"
            # Download key headers needed
            curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/PSListController.h" -o "$HOME/theos/include/Preferences/PSListController.h" || true
            curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/PSSpecifier.h" -o "$HOME/theos/include/Preferences/PSSpecifier.h" || true
            curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/PSTableCell.h" -o "$HOME/theos/include/Preferences/PSTableCell.h" || true
            
            if [ -f "$HOME/theos/include/Preferences/PSListController.h" ]; then
              echo "✅ Downloaded Preferences headers from GitHub"
              FOUND_HEADERS=1
            fi
          fi
          
          if [ $FOUND_HEADERS -eq 0 ]; then
            echo "❌ Failed to find Preferences headers from any source"
            exit 1
          fi
          
          # Copy local Preferences.tbd for linking
          mkdir -p "$HOME/theos/lib"
          if [ -f "theos/lib/Preferences.tbd" ]; then
            cp theos/lib/Preferences.tbd "$HOME/theos/lib/"
            echo "✅ Preferences.tbd copied for linking"
          else
            echo "❌ theos/lib/Preferences.tbd not found in repo"
            exit 1
          fi
          
          # Verify setup
          echo ""
          echo "Preferences setup complete:"
          ls -la "$HOME/theos/include/Preferences/" | head -10
          echo ""
          ls -la "$HOME/theos/lib/Preferences.tbd"

      - name: Build VolumeMixer (arm64e for M2)
        env:
          THEOS: ${{ env.THEOS }}
        run: |
          export THEOS=$HOME/theos
          export SDKVERSION=16.0
          
          # Clean previous builds
          make clean || true
          
          # Build with explicit flags for iOS 16 / arm64e
          make package \
            FINALPACKAGE=1 \
            THEOS_PACKAGE_SCHEME=rootless \
            DEBUG=0 \
            ARCHS=arm64e \
            TARGET=iphone:clang:latest:16.0

      - name: Check Build Output
        run: |
          echo "Contents of packages directory:"
          ls -lah packages/ 2>/dev/null || echo "No packages directory"
          echo ""
          echo "Contents of .theos directory:"
          ls -lah .theos/obj/ 2>/dev/null || echo "No .theos/obj directory"

      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: VolumeMixer_DEB_iOS16
          path: packages/*.deb
