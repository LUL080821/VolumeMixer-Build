name: Build VolumeMixer
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      - name: Install iOS SDK
        run: |
          cd $HOME/theos
          curl -LO https://github.com/theos/sdks/archive/master.zip
          unzip master.zip
          mv sdks-master sdks
          rm master.zip
          echo "‚úÖ Theos SDKs installed"
          ls -la sdks/ | head -10

      - name: Install LibActivator Headers
        run: |
          git clone https://github.com/rpetrich/libactivator.git libactivator_src
          mkdir -p $HOME/theos/include/libactivator
          cp libactivator_src/*.h $HOME/theos/include/libactivator/ 2>/dev/null || true
          rm -rf libactivator_src
          echo "‚úÖ LibActivator headers installed"

      - name: Install AltList Framework
        run: |
          git clone https://github.com/opa334/AltList.git altlist_src
          
          mkdir -p $HOME/theos/include/AltList
          if [ -d "altlist_src/AltList" ]; then
            cp altlist_src/AltList/*.h $HOME/theos/include/AltList/ 2>/dev/null || true
          fi
          if [ -d "altlist_src" ]; then
            find altlist_src -name "*.h" -exec cp {} $HOME/theos/include/AltList/ \; 2>/dev/null || true
          fi
          
          mkdir -p $HOME/theos/lib
          cat > $HOME/theos/lib/AltList.tbd << 'EOF'
---
archs:           [ arm64, arm64e ]
platform:        ios
install-name:    /Library/Frameworks/AltList.framework/AltList
exports:
  - archs:           [ arm64, arm64e ]
    symbols:         [ _OBJC_CLASS_$_ATLApplicationListController ]
EOF
          
          rm -rf altlist_src
          echo "‚úÖ AltList framework installed"

      - name: Install Ldid
        run: |
          curl -L https://github.com/ProcursusTeam/ldid/releases/download/v2.1.5-procursus7/ldid_macosx_x86_64 -o /tmp/ldid
          chmod +x /tmp/ldid
          sudo mv /tmp/ldid /usr/local/bin/ldid
          ldid -V || echo "ldid version check failed"
          echo "‚úÖ ldid installed"

      - name: Setup Preferences Framework
        run: |
          FOUND_HEADERS=0
          
          LATEST_SDK=$(ls -d $HOME/theos/sdks/iPhoneOS*.sdk 2>/dev/null | sort -V | tail -1)
          if [ -n "$LATEST_SDK" ]; then
            echo "üì¶ Using SDK: $LATEST_SDK"
            
            if [ -d "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework" ]; then
              mkdir -p "$HOME/theos/include/Preferences"
              
              if [ -d "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers" ]; then
                cp -R "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers/"* "$HOME/theos/include/Preferences/"
                FOUND_HEADERS=1
              else
                find "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework" -name "*.h" -exec cp {} "$HOME/theos/include/Preferences/" \; 2>/dev/null
                if [ -f "$HOME/theos/include/Preferences/PSListController.h" ]; then
                  FOUND_HEADERS=1
                fi
              fi
            fi
          fi
          
          if [ $FOUND_HEADERS -eq 0 ]; then
            echo "‚ö†Ô∏è  Downloading Preferences headers from GitHub..."
            mkdir -p "$HOME/theos/include/Preferences"
            
            curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/PSListController.h" -o "$HOME/theos/include/Preferences/PSListController.h" || true
            curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/PSSpecifier.h" -o "$HOME/theos/include/Preferences/PSSpecifier.h" || true
            curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/PSTableCell.h" -o "$HOME/theos/include/Preferences/PSTableCell.h" || true
            curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/PSViewController.h" -o "$HOME/theos/include/Preferences/PSViewController.h" || true
            
            if [ -f "$HOME/theos/include/Preferences/PSListController.h" ]; then
              FOUND_HEADERS=1
            fi
          fi
          
          if [ $FOUND_HEADERS -eq 0 ]; then
            echo "‚ùå Failed to get Preferences headers"
            exit 1
          fi
          
          echo "‚úÖ Preferences headers installed"
          
          mkdir -p "$HOME/theos/lib"
          if [ -f "theos/lib/Preferences.tbd" ]; then
            cp theos/lib/Preferences.tbd "$HOME/theos/lib/"
            echo "‚úÖ Preferences.tbd copied"
          else
            echo "‚ùå Preferences.tbd not found in repo"
            exit 1
          fi

      - name: Build VolumeMixer (iOS 16.0 arm64e Rootless)
        env:
          THEOS: ${{ env.THEOS }}
        run: |
          export THEOS=$HOME/theos
          
          echo "üî® Building VolumeMixer for iOS 16.0 arm64e (M2 iPad) with Dopamine2-roothide support..."
          echo "Configuration from Makefile:"
          echo "  - Architecture: arm64e"
          echo "  - iOS Target: 16.0"
          echo "  - Package Scheme: rootless"
          echo ""
          
          make clean || true
          
          # Build using Makefile settings (no overrides)
          make package FINALPACKAGE=1 DEBUG=0 MESSAGES=yes 2>&1 | tee build.log
          
          BUILD_STATUS=$?
          echo ""
          if [ $BUILD_STATUS -eq 0 ]; then
            echo "‚úÖ Build completed successfully"
          else
            echo "‚ùå Build failed with status $BUILD_STATUS"
            echo "Showing last 50 lines of build log:"
            tail -50 build.log
            exit $BUILD_STATUS
          fi

      - name: Locate and Verify Package
        run: |
          echo "üì¶ Locating built package..."
          echo ""
          
          # Standard package location
          if [ -d "packages" ]; then
            echo "=== packages/ directory ==="
            ls -lah packages/
            
            PACKAGE_FILE=$(find packages -name "*.deb" -type f | head -1)
            if [ -n "$PACKAGE_FILE" ]; then
              echo ""
              echo "‚úÖ Package found: $PACKAGE_FILE"
              echo ""
              echo "Package info:"
              dpkg-deb --info "$PACKAGE_FILE"
              echo ""
              echo "Package contents (first 30 files):"
              dpkg-deb --contents "$PACKAGE_FILE" | head -30
            fi
          else
            echo "‚ö†Ô∏è  No packages/ directory found"
          fi
          
          echo ""
          echo "=== All .deb files in project ==="
          find . -name "*.deb" -type f -exec ls -lh {} \;
          
          echo ""
          echo "=== .theos structure ==="
          if [ -d ".theos" ]; then
            echo "Files in .theos/_/:"
            find .theos/_ -type f 2>/dev/null | head -20 || echo "No staged files"
            echo ""
            echo "Looking for .deb:"
            find .theos -name "*.deb" 2>/dev/null || echo "No .deb found"
          else
            echo "No .theos directory"
          fi

      - name: Prepare Artifacts
        run: |
          mkdir -p artifacts
          
          # Find and copy all .deb files
          FOUND_COUNT=0
          for deb in $(find . -name "*.deb" -type f 2>/dev/null); do
            echo "üì¶ Copying: $deb"
            cp "$deb" artifacts/
            FOUND_COUNT=$((FOUND_COUNT + 1))
          done
          
          if [ $FOUND_COUNT -eq 0 ]; then
            echo "‚ùå ERROR: No .deb files found!"
            echo "Build may have failed. Check build logs above."
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Prepared $FOUND_COUNT package(s)"
          ls -lah artifacts/

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: VolumeMixer_iOS16_arm64e_rootless_M2
          path: artifacts/*.deb
          if-no-files-found: error

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build.log
            .theos/_/DEBIAN/control
          if-no-files-found: ignore
