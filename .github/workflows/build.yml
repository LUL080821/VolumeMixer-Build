name: Build VolumeMixer
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dpkg (Critical for packaging)
        run: |
          echo "üì¶ Installing dpkg for .deb package creation..."
          brew install dpkg
          which dpkg-deb
          dpkg-deb --version
          echo "‚úÖ dpkg-deb installed and verified"

      - name: Install Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "‚úÖ Theos installed"

      - name: Install iOS SDK
        run: |
          set -e
          echo "üì¶ Downloading and installing iOS SDK 16.5..."
          cd $HOME/theos
          
          # Create sdks directory
          mkdir -p sdks
          
          # Download the specific SDK in tar.xz format (more reliable than zip)
          echo "Downloading iPhoneOS16.5.sdk.tar.xz..."
          curl -L https://github.com/theos/sdks/releases/latest/download/iPhoneOS16.5.sdk.tar.xz -o sdks/iPhoneOS16.5.sdk.tar.xz
          
          # Extract the SDK
          echo "Extracting SDK..."
          cd sdks
          tar -xf iPhoneOS16.5.sdk.tar.xz
          rm iPhoneOS16.5.sdk.tar.xz
          
          # Verify SDK exists
          echo ""
          echo "Available SDKs:"
          ls -la
          echo ""
          
          if [ ! -d "iPhoneOS16.5.sdk" ]; then
            echo "‚ùå ERROR: iPhoneOS16.5.sdk not found after extraction!"
            echo "Contents of sdks directory:"
            ls -la
            exit 1
          fi
          
          echo "‚úÖ iPhoneOS16.5.sdk verified and installed"

      - name: Install LibActivator Headers
        run: |
          git clone --depth=1 https://github.com/rpetrich/libactivator.git libactivator_src
          mkdir -p $HOME/theos/include/libactivator
          cp libactivator_src/*.h $HOME/theos/include/libactivator/ 2>/dev/null || true
          rm -rf libactivator_src
          echo "‚úÖ LibActivator headers installed"

      - name: Install AltList Framework (CRITICAL FIX)
        run: |
          git clone --depth=1 https://github.com/opa334/AltList.git altlist_src
          
          # Install headers
          mkdir -p $HOME/theos/include/AltList
          find altlist_src -name "*.h" -exec cp {} $HOME/theos/include/AltList/ \; 2>/dev/null || true
          
          # CRITICAL: Create framework structure in rootless directory
          # The Makefile uses "volumemixer_EXTRA_FRAMEWORKS += AltList" which means
          # the linker searches with "-framework AltList" flag, looking for:
          # AltList.framework/AltList in framework search paths (-F directories)
          
          echo "üîß Creating AltList.framework structure in rootless directory..."
          mkdir -p "$HOME/theos/lib/iphone/rootless/AltList.framework"
          
          # Create the framework's main binary file (AltList.tbd)
          echo "---" > "$HOME/theos/lib/iphone/rootless/AltList.framework/AltList"
          echo "archs:           [ arm64, arm64e ]" >> "$HOME/theos/lib/iphone/rootless/AltList.framework/AltList"
          echo "platform:        ios" >> "$HOME/theos/lib/iphone/rootless/AltList.framework/AltList"
          echo "install-name:    /Library/Frameworks/AltList.framework/AltList" >> "$HOME/theos/lib/iphone/rootless/AltList.framework/AltList"
          echo "exports:" >> "$HOME/theos/lib/iphone/rootless/AltList.framework/AltList"
          echo "  - archs:           [ arm64, arm64e ]" >> "$HOME/theos/lib/iphone/rootless/AltList.framework/AltList"
          echo "    symbols:         [ _OBJC_CLASS_\$_ATLApplicationListController ]" >> "$HOME/theos/lib/iphone/rootless/AltList.framework/AltList"
          echo "..." >> "$HOME/theos/lib/iphone/rootless/AltList.framework/AltList"
          
          # Verify framework structure
          echo ""
          echo "üìÅ AltList.framework structure:"
          ls -lah "$HOME/theos/lib/iphone/rootless/AltList.framework/"
          echo ""
          
          rm -rf altlist_src
          echo "‚úÖ AltList framework installed in rootless directory"

      - name: Install Ldid
        run: |
          curl -L https://github.com/ProcursusTeam/ldid/releases/download/v2.1.5-procursus7/ldid_macosx_x86_64 -o /tmp/ldid
          chmod +x /tmp/ldid
          sudo mv /tmp/ldid /usr/local/bin/ldid
          ldid -V || echo "ldid installed"
          echo "‚úÖ ldid installed"

      - name: Setup Preferences Framework
        run: |
          # Create rootless lib directory
          echo "üîß Creating rootless lib directory..."
          mkdir -p "$HOME/theos/lib/iphone/rootless"
          
          # Copy repo's Preferences.tbd if it exists, otherwise create it
          if [ -f "theos/lib/Preferences.tbd" ]; then
            echo "‚úÖ Using Preferences.tbd from repository"
            cp theos/lib/Preferences.tbd "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
          else
            echo "‚ö†Ô∏è Creating Preferences.tbd in rootless directory"
            echo "---" > "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "archs:           [ arm64, arm64e ]" >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "platform:        ios" >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "install-name:    /System/Library/PrivateFrameworks/Preferences.framework/Preferences" >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "exports:" >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "  - archs:           [ arm64, arm64e ]" >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "    symbols:         [ ]" >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
            echo "..." >> "$HOME/theos/lib/iphone/rootless/Preferences.tbd"
          fi
          
          # Create libPreferences.tbd symlink in rootless directory
          cd "$HOME/theos/lib/iphone/rootless"
          ln -sf Preferences.tbd libPreferences.tbd
          echo "‚úÖ Created libPreferences.tbd symlink in rootless directory"
          
          # Verify both files exist in rootless directory
          echo ""
          echo "üìÅ Contents of rootless lib directory:"
          ls -lah "$HOME/theos/lib/iphone/rootless/" | grep -i preferences
          echo ""
          
          # Setup Preferences headers
          mkdir -p "$HOME/theos/include/Preferences"
          LATEST_SDK=$(ls -d $HOME/theos/sdks/iPhoneOS*.sdk 2>/dev/null | sort -V | tail -1)
          if [ -n "$LATEST_SDK" ] && [ -d "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers" ]; then
            cp -R "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers/"* "$HOME/theos/include/Preferences/"
            echo "‚úÖ Preferences headers from SDK"
          else
            echo "‚ö†Ô∏è Downloading Preferences headers from GitHub"
            for header in PSListController.h PSSpecifier.h PSTableCell.h PSViewController.h; do
              curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/$header" -o "$HOME/theos/include/Preferences/$header" || true
            done
          fi
          
          if [ ! -f "$HOME/theos/include/Preferences/PSListController.h" ]; then
            echo "‚ùå Failed to get Preferences headers"
            exit 1
          fi
          echo "‚úÖ Preferences framework ready"

      - name: Build VolumeMixer (iOS 16.0 arm64e Rootless)
        env:
          THEOS: ${{ env.THEOS }}
        run: |
          export THEOS=$HOME/theos
          export PATH="/usr/local/bin:$PATH"
          
          echo "üî® Building VolumeMixer for iOS 16.0 arm64e (M2 iPad Dopamine2-roothide)"
          echo "üìç Working directory: $(pwd)"
          echo "üìç THEOS: $THEOS"
          echo "üìç dpkg-deb: $(which dpkg-deb)"
          echo "üìç Available SDKs:"
          ls -la $THEOS/sdks/ | grep -E '\.sdk$' || echo "No SDKs found"
          echo ""
          echo "üìç Rootless lib directory:"
          ls -lah $THEOS/lib/iphone/rootless/ 2>/dev/null || echo "Directory empty"
          echo ""
          echo "üìç Frameworks in rootless:"
          ls -lah $THEOS/lib/iphone/rootless/*.framework 2>/dev/null || echo "No frameworks"
          echo ""
          
          # Verify dpkg-deb is available
          if ! command -v dpkg-deb &> /dev/null; then
            echo "‚ùå CRITICAL: dpkg-deb not found!"
            exit 1
          fi
          
          # Verify SDK exists before building
          if [ ! -d "$THEOS/sdks/iPhoneOS16.5.sdk" ]; then
            echo "‚ùå CRITICAL: iPhoneOS16.5.sdk not found in $THEOS/sdks/"
            exit 1
          fi
          
          # Verify libPreferences.tbd exists in rootless directory
          if [ ! -f "$THEOS/lib/iphone/rootless/libPreferences.tbd" ]; then
            echo "‚ùå CRITICAL: libPreferences.tbd not found in rootless directory!"
            exit 1
          fi
          
          # Verify AltList.framework exists
          if [ ! -f "$THEOS/lib/iphone/rootless/AltList.framework/AltList" ]; then
            echo "‚ùå CRITICAL: AltList.framework/AltList not found!"
            exit 1
          fi
          
          echo "‚úÖ All pre-build verifications passed"
          echo ""
          
          # Clean previous builds
          make clean || true
          rm -rf packages .theos/_/packages 2>/dev/null || true
          
          # Build with explicit settings for iOS 16.0 rootless
          echo "üîß Building with: make package FINALPACKAGE=1 DEBUG=0"
          make package FINALPACKAGE=1 DEBUG=0 MESSAGES=yes 2>&1 | tee build.log
          
          BUILD_STATUS=${PIPESTATUS[0]}
          echo ""
          if [ $BUILD_STATUS -ne 0 ]; then
            echo "‚ùå Build failed with status $BUILD_STATUS"
            echo "=== Last 100 lines of build log ==="
            tail -100 build.log
            exit $BUILD_STATUS
          fi
          
          echo "‚úÖ Build command completed successfully"

      - name: Verify Package Generation
        run: |
          echo "üì¶ Verifying generated .deb packages..."
          echo ""
          
          # Search for .deb files in all possible locations
          FOUND_DEBS=$(find . -name "*.deb" -type f 2>/dev/null)
          
          if [ -z "$FOUND_DEBS" ]; then
            echo "‚ùå CRITICAL ERROR: No .deb files were generated!"
            echo ""
            echo "=== Checking build staging directory ==="
            if [ -d ".theos/_" ]; then
              echo "Contents of .theos/_:"
              ls -lah .theos/_/
              echo ""
              if [ -f ".theos/_/DEBIAN/control" ]; then
                echo "DEBIAN/control exists:"
                cat .theos/_/DEBIAN/control
              else
                echo "‚ùå No DEBIAN/control file found"
              fi
            else
              echo "‚ùå .theos/_ directory doesn't exist"
            fi
            echo ""
            echo "=== Build log tail ==="
            tail -50 build.log
            exit 1
          else
            echo "‚úÖ Successfully found .deb package(s):"
            echo "$FOUND_DEBS" | while read deb; do
              echo ""
              echo "üì¶ Package: $deb"
              ls -lh "$deb"
              echo "Package info:"
              dpkg-deb --info "$deb" || echo "(Info unavailable)"
              echo "Package contents:"
              dpkg-deb --contents "$deb" | head -20
            done
          fi

      - name: Prepare Artifacts
        run: |
          mkdir -p artifacts
          
          # Copy all .deb files to artifacts directory
          FOUND_COUNT=0
          for deb in $(find . -name "*.deb" -type f 2>/dev/null); do
            BASENAME=$(basename "$deb")
            echo "üì¶ Copying: $deb -> artifacts/$BASENAME"
            cp "$deb" "artifacts/$BASENAME"
            FOUND_COUNT=$((FOUND_COUNT + 1))
          done
          
          if [ $FOUND_COUNT -eq 0 ]; then
            echo "‚ùå ERROR: No .deb files to upload!"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Prepared $FOUND_COUNT package(s) for upload:"
          ls -lah artifacts/

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: VolumeMixer-iOS16-arm64e-rootless-M2
          path: artifacts/*.deb
          if-no-files-found: error
          retention-days: 90

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build.log
            .theos/_/DEBIAN/control
          if-no-files-found: ignore
          retention-days: 30
