name: Build VolumeMixer
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      - name: Install iOS SDK
        run: |
          cd $HOME/theos
          curl -LO https://github.com/theos/sdks/archive/master.zip
          unzip -q master.zip
          mv sdks-master sdks
          rm master.zip
          echo "‚úÖ Theos SDKs installed"

      - name: Install LibActivator Headers
        run: |
          git clone --depth=1 https://github.com/rpetrich/libactivator.git libactivator_src
          mkdir -p $HOME/theos/include/libactivator
          cp libactivator_src/*.h $HOME/theos/include/libactivator/ 2>/dev/null || true
          rm -rf libactivator_src
          echo "‚úÖ LibActivator headers installed"

      - name: Install AltList Framework
        run: |
          git clone --depth=1 https://github.com/opa334/AltList.git altlist_src
          
          mkdir -p $HOME/theos/include/AltList
          find altlist_src -name "*.h" -exec cp {} $HOME/theos/include/AltList/ \; 2>/dev/null || true
          
          mkdir -p $HOME/theos/lib
          cat > $HOME/theos/lib/AltList.tbd << 'EOF'
---
archs:           [ arm64, arm64e ]
platform:        ios
install-name:    /Library/Frameworks/AltList.framework/AltList
exports:
  - archs:           [ arm64, arm64e ]
    symbols:         [ _OBJC_CLASS_$_ATLApplicationListController ]
EOF
          
          rm -rf altlist_src
          echo "‚úÖ AltList framework installed"

      - name: Install Ldid
        run: |
          curl -L https://github.com/ProcursusTeam/ldid/releases/download/v2.1.5-procursus7/ldid_macosx_x86_64 -o /tmp/ldid
          chmod +x /tmp/ldid
          sudo mv /tmp/ldid /usr/local/bin/ldid
          ldid -V || echo "ldid installed"
          echo "‚úÖ ldid installed"

      - name: Setup Preferences Framework
        run: |
          mkdir -p "$HOME/theos/lib"
          if [ -f "theos/lib/Preferences.tbd" ]; then
            cp theos/lib/Preferences.tbd "$HOME/theos/lib/"
            echo "‚úÖ Preferences.tbd copied from repo"
          else
            echo "‚ö†Ô∏è Preferences.tbd not found in repo, creating minimal version"
            cat > "$HOME/theos/lib/Preferences.tbd" << 'EOF'
---
archs:           [ arm64, arm64e ]
platform:        ios
install-name:    /System/Library/PrivateFrameworks/Preferences.framework/Preferences
EOF
          fi
          
          mkdir -p "$HOME/theos/include/Preferences"
          LATEST_SDK=$(ls -d $HOME/theos/sdks/iPhoneOS*.sdk 2>/dev/null | sort -V | tail -1)
          if [ -n "$LATEST_SDK" ] && [ -d "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers" ]; then
            cp -R "$LATEST_SDK/System/Library/PrivateFrameworks/Preferences.framework/Headers/"* "$HOME/theos/include/Preferences/"
            echo "‚úÖ Preferences headers from SDK"
          else
            echo "‚ö†Ô∏è Downloading Preferences headers from GitHub"
            for header in PSListController.h PSSpecifier.h PSTableCell.h PSViewController.h; do
              curl -fsSL "https://raw.githubusercontent.com/theos/headers/master/Preferences/$header" -o "$HOME/theos/include/Preferences/$header" || true
            done
          fi
          
          if [ ! -f "$HOME/theos/include/Preferences/PSListController.h" ]; then
            echo "‚ùå Failed to get Preferences headers"
            exit 1
          fi
          echo "‚úÖ Preferences framework ready"

      - name: Build VolumeMixer (iOS 16.0 arm64e Rootless)
        env:
          THEOS: ${{ env.THEOS }}
        run: |
          export THEOS=$HOME/theos
          export PATH="/usr/local/bin:$PATH"
          
          echo "üî® Building VolumeMixer for iOS 16.0 arm64e (M2 iPad Dopamine2-roothide)"
          echo "üìç Working directory: $(pwd)"
          echo "üìç THEOS: $THEOS"
          echo ""
          
          # Clean previous builds
          make clean || true
          rm -rf packages .theos/_/packages 2>/dev/null || true
          
          # Build with explicit package generation
          echo "üîß Running: make package FINALPACKAGE=1 DEBUG=0"
          make package FINALPACKAGE=1 DEBUG=0 MESSAGES=yes 2>&1 | tee build.log
          
          BUILD_STATUS=${PIPESTATUS[0]}
          echo ""
          if [ $BUILD_STATUS -ne 0 ]; then
            echo "‚ùå Build failed with status $BUILD_STATUS"
            echo "=== Last 100 lines of build log ==="
            tail -100 build.log
            exit $BUILD_STATUS
          fi
          
          echo "‚úÖ Build command completed"

      - name: Locate and Verify Package
        run: |
          echo "üì¶ Searching for generated .deb packages..."
          echo ""
          
          # Check all possible locations
          echo "=== Searching in packages/ ==="
          if [ -d "packages" ]; then
            find packages -name "*.deb" -type f -exec ls -lh {} \; || echo "No .deb in packages/"
          else
            echo "‚ùå packages/ directory does not exist"
          fi
          
          echo ""
          echo "=== Searching in .theos/ ==="
          if [ -d ".theos" ]; then
            find .theos -name "*.deb" -type f -exec ls -lh {} \; || echo "No .deb in .theos/"
          else
            echo "‚ùå .theos/ directory does not exist"
          fi
          
          echo ""
          echo "=== Searching entire project ==="
          FOUND_DEBS=$(find . -name "*.deb" -type f 2>/dev/null)
          if [ -z "$FOUND_DEBS" ]; then
            echo "‚ùå CRITICAL: No .deb files found anywhere!"
            echo ""
            echo "=== Checking THEOS staging directory ==="
            if [ -d ".theos/_" ]; then
              echo "Files in .theos/_/:"
              find .theos/_ -type f 2>/dev/null | head -30
              echo ""
              if [ -f ".theos/_/DEBIAN/control" ]; then
                echo "control file exists:"
                cat .theos/_/DEBIAN/control
              else
                echo "‚ùå No DEBIAN/control file - packaging didn't start"
              fi
            fi
            echo ""
            echo "=== Checking if dpkg-deb is available ==="
            which dpkg-deb || echo "‚ùå dpkg-deb not found"
            brew list | grep dpkg || echo "dpkg not installed via brew"
            exit 1
          else
            echo "‚úÖ Found .deb files:"
            echo "$FOUND_DEBS" | while read deb; do
              echo ""
              echo "üì¶ Package: $deb"
              ls -lh "$deb"
              if command -v dpkg-deb &> /dev/null; then
                echo "Package info:"
                dpkg-deb --info "$deb" 2>/dev/null || echo "(dpkg-deb info unavailable)"
              fi
            done
          fi

      - name: Install dpkg tools
        if: failure()
        run: |
          echo "Installing dpkg for packaging..."
          brew install dpkg

      - name: Retry Package Build with dpkg
        if: failure()
        run: |
          export THEOS=$HOME/theos
          export PATH="/usr/local/bin:$PATH"
          echo "üîÑ Retrying package build with dpkg installed..."
          make package FINALPACKAGE=1 DEBUG=0

      - name: Prepare Artifacts
        run: |
          mkdir -p artifacts
          
          # Find and copy all .deb files from all locations
          FOUND_COUNT=0
          for location in packages .theos/packages .theos .; do
            if [ -d "$location" ]; then
              for deb in $(find "$location" -maxdepth 2 -name "*.deb" -type f 2>/dev/null); do
                echo "üì¶ Copying: $deb -> artifacts/"
                cp "$deb" artifacts/
                FOUND_COUNT=$((FOUND_COUNT + 1))
              done
            fi
          done
          
          if [ $FOUND_COUNT -eq 0 ]; then
            echo "‚ùå ERROR: No .deb files found to upload!"
            echo "This should not happen if previous steps passed."
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Prepared $FOUND_COUNT package(s) for upload:"
          ls -lah artifacts/

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: VolumeMixer-iOS16-arm64e-rootless-M2
          path: artifacts/*.deb
          if-no-files-found: error

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build.log
            .theos/_/DEBIAN/control
          if-no-files-found: ignore
